# apiVersion: argoproj.io/v1alpha1
# kind: ApplicationSet
# metadata:
#   name: workloads-staging
#   namespace: argocd
#   annotations:
#      argocd-image-updater.argoproj.io/image-list: horizonclient/nginx-personal:~v0.1
#      argocd-image-updater.argoproj.io/write-back-method: git
#   finalizers:
#    - resources-finalizer.argocd.argoproj.io
# spec:
#   syncPolicy:
#     preserveResourcesOnDeletion: false
#   generators:
#     - merge:
#         mergeKeys: [server]
#         generators:
#           - clusters:
#               selector:
#                 matchLabels:
#                   environment: staging

#           - git:
#               repoURL: '{{metadata.annotations.workload_repo_url}}'
#               revision: '{{metadata.annotations.workload_repo_revision}}'
#               directories:
#               - path: '{{metadata.annotations.workload_repo_basepath}}{{metadata.annotations.workload_repo_path}}/*'
#   template:
#     metadata:
#       name: 'workload-{{metadata.labels.environment}}-{{path.basename}}'
#       labels:
#         workload: 'true'
#     spec:
#       project: default
#       source:
#         repoURL: '{{metadata.annotations.workload_repo_url}}'
#         path: '{{metadata.annotations.workload_repo_basepath}}{{metadata.annotations.workload_repo_path}}/{{path.basename}}/environments/staging'
#         targetRevision: '{{metadata.annotations.workload_repo_revision}}'
#       destination:
#         namespace: 'workload-{{path.basename}}'
#         name: '{{name}}'
#       syncPolicy:
#         automated: {}
#         syncOptions:
#           - CreateNamespace=true